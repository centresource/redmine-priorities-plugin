<% 
#New todo: partial for creating a new todo.
#requires:
#   todo : a new Todo object
  parent_object = todo.todoable
  raise unless parent_object
%>

<div class="new-todo">
  <h3>New Priority</h3>
  <% remote_form_for [parent_object,todo],
      #:todo, todo, :url => {:controller => "todos", :action=> "create", :project_id => todo.project },
      #:update =>  TodosController::UL_ID + todo.parent_or_root_id, :position => :bottom,
      :success => "elements['todo[text]'].activate().clear();" do |f| %>
      
    <%= f.hidden_field :due, :id => "due#{todo.parent_id}", 
      :onchange => "$('due#{todo.parent_id}_span').update($('due#{todo.parent_id}').value); $('due#{todo.parent_id}_cancel_span').show();" %>
    <%= f.hidden_field :parent_id %>
    
    <div class="todo-fieldgroup">
      <%= f.label :text, 'Title' %>
      <%= f.text_field :text, :size => 40 %>
    </div>
    
    <div class="todo-fieldgroup">
      <label><%= l(:todo_new_due_label) %></label>
      <div class="todo-due-date">
        <span id='<%= "due#{todo.parent_id}_span" %>' class="todo-date"></span>
        <span id='<%= "due#{todo.parent_id}_cancel_span" %>' class='new-todo-date-cancel' style='display: none;'>
          <%= 
              link_to_function(image_tag('bullet_delete.png'), nil, :title => "Clear Date") do |page|
                page["due#{todo.parent_id}"].value = ''
                page.replace_html "due#{todo.parent_id}_span", ''
                page.hide "due#{todo.parent_id}_cancel_span"
              end 
          %>
        </span>
        <span class="todo-due-cal">
          <%= calendar_for "due#{todo.parent_id}" %>
        </span>
      </div>
    </div>
    
    <div class="clearer"></div>

    <% if todo.todoable.is_a? Project %>
      <div class='todo-fieldgroup'>
        <label>Assigned to:</label>
        <%= f.select :assigned_to_id, todo.todoable.users.collect{ |m| [m.name,m.id] },
             {:prompt => l(:todo_new_assign_to_tooltip) },  
             {:title => l(:todo_new_assign_to_tooltip) }
        %>
      </div>
      
      <div class="todo-fieldgroup">
        <label>References Issue:</label>
        <%= f.select :issue_id, todo.possible_issues.collect{ |i| 
                subject = i.subject[0..40].scan(/([\x00-\x7f]|[\xC0-\xDF][\x80-\xBF]|[\xE0-\xEF][\x80-\xBF]{2}|[\xF0-\xF7][\x80-\xBF]{3})/on).join
                ["##{i.id} #{subject}... #{i.tracker.name}" , i.id]
              },
              {:prompt => l(:todo_new_issue_tooltip), :selected => (todo.issue_id)?  todo.issue_id.to_i : nil}
        %>
      </div>
      
      <div class="clearer"></div>
    <% end %>
    
    <%= f.submit l(:todo_new_create_button) %>
    
    <% if todo.parent %>
      <%= l(:todo_new_or_label) %>
      <%= link_to_function(l(:todo_new_done_link),
         "Element.update('todo#{todo.parent_id}-new-box','')") %>
    <% end %>
  <% end %>
</div>
